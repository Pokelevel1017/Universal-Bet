<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal-Bet | Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --dark-blue: #0b1120; --mid-blue: #1e293b; --light-blue: #38bdf8; 
            --accent-green: #00e701; --card-bg: #111827; --text-muted: #94a3b8;
            --premium-gradient: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            --modal-bg: #0f172a;
        }

        body { background-color: var(--dark-blue); color: white; font-family: 'Inter', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* NAVIGATION */
        nav { background: #070b14; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; height: 75px; border-bottom: 1px solid var(--mid-blue); flex-shrink: 0; z-index: 100; }
        .logo { font-size: 1.5rem; font-weight: 900; letter-spacing: -1px; cursor: pointer; }
        .logo span { color: var(--light-blue); }
        .nav-right { display: flex; align-items: center; gap: 12px; }
        .header-reward-box { background: rgba(56, 189, 248, 0.1); border: 1px solid rgba(56, 189, 248, 0.2); padding: 8px 15px; border-radius: 8px; display: none; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
        .reward-timer-text { font-size: 11px; font-weight: 800; color: var(--light-blue); text-transform: uppercase; }
        .balance-box { background: var(--mid-blue); padding: 10px 20px; border-radius: 8px; font-weight: 800; color: var(--accent-green); display: flex; align-items: center; gap: 10px; font-size: 1.1rem; border: 1px solid rgba(56, 189, 248, 0.2); visibility: hidden; }

        /* LAYOUT */
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 280px; background: #070b14; border-right: 1px solid var(--mid-blue); padding: 20px 12px; display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; overflow-y: auto; }
        .sidebar-label { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin: 20px 0 10px 15px; letter-spacing: 1px; }
        .side-link { padding: 12px 15px; border-radius: 8px; color: var(--text-muted); text-decoration: none; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 14px; }
        .side-link:hover, .active-link { background: var(--mid-blue); color: white; }

        /* DASHBOARD CONTENT */
        .dashboard { flex: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at top left, #1e293b, #0b1120); }
        .status-header { margin-bottom: 30px; }
        .status-header h1 { font-size: 2.2rem; font-weight: 900; margin: 0; }
        .highlight { color: var(--light-blue); }

        /* TABS */
        .tab-nav { display: flex; gap: 10px; border-bottom: 1px solid var(--mid-blue); margin-bottom: 30px; position: relative; }
        .tab-btn { padding: 12px 24px; background: none; border: none; color: var(--text-muted); font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 13px; border-bottom: 2px solid transparent; transition: 0.2s; position: relative; }
        .tab-btn.active { color: var(--light-blue); border-bottom-color: var(--light-blue); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* NOTIFICATION BADGE */
        .notify-badge { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; display: none; border: 2px solid var(--dark-blue); }

        /* NEWS TAB + FEED */
        .news-container { display: grid; grid-template-columns: 1fr 350px; gap: 30px; align-items: stretch; }
        @media (max-width: 1000px) { .news-container { grid-template-columns: 1fr; } }
        .news-main { display: flex; flex-direction: column; gap: 20px; }
        .news-card { background: var(--card-bg); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); padding: 25px; transition: 0.3s; position: relative; flex: 1; }
        .news-card:hover { border-color: var(--light-blue); background: #161f2e; }
        .news-tag { font-size: 10px; font-weight: 900; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; margin-bottom: 15px; display: inline-block; }
        .tag-update { background: rgba(56, 189, 248, 0.2); color: var(--light-blue); }
        .tag-live { background: rgba(0, 231, 1, 0.2); color: var(--accent-green); animation: pulse 2s infinite; }
        .news-title { font-size: 1.4rem; font-weight: 900; margin: 10px 0; }
        .news-excerpt { color: var(--text-muted); line-height: 1.6; font-size: 14px; }

        .live-feed { background: var(--card-bg); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); padding: 25px; display: flex; flex-direction: column; height: 450px; }
        .feed-scroll { flex: 1; overflow-y: auto; scrollbar-width: none; }
        .feed-scroll::-webkit-scrollbar { display: none; }
        .feed-item { display: flex; flex-direction: column; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); animation: slideIn 0.4s ease-out; }
        .feed-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .feed-user { font-weight: 800; color: white; font-size: 13px; cursor: pointer; }
        .feed-user:hover { color: var(--light-blue); text-decoration: underline; }
        .feed-amount { color: var(--accent-green); font-weight: 900; font-size: 13px; }
        .feed-time { font-size: 10px; color: var(--text-muted); margin-top: 4px; font-weight: 700; text-transform: uppercase; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* LEADERBOARD TABLE */
        .leaderboard-table { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 12px; overflow: hidden; border: 1px solid var(--mid-blue); }
        .leaderboard-table th { background: #070b14; padding: 18px; color: var(--text-muted); text-align: left; font-size: 11px; text-transform: uppercase; }
        .leaderboard-table td { padding: 18px; border-top: 1px solid var(--mid-blue); font-size: 14px; }
        .player-cell { cursor: pointer; font-weight: 700; }
        .player-cell:hover { color: var(--light-blue); }
        .bal-cell { color: var(--accent-green); font-weight: 900; text-align: right; font-family: monospace; font-size: 1.1rem; }
        .rank-badge { font-weight: 900; color: white; background: var(--mid-blue); padding: 4px 10px; border-radius: 6px; }
        .rank-1 { background: #fbbf24; color: #000; }
        .rank-2 { background: #94a3b8; color: #000; }
        .rank-3 { background: #92400e; color: #fff; }

        /* ABOUT BOX */
        .about-box { background: var(--card-bg); padding: 30px; border-radius: 16px; border: 1px solid var(--mid-blue); line-height: 1.8; }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(8px); }
        .modal { background: #0f172a; padding: 50px 40px; border-radius: 28px; width: 100%; max-width: 420px; border: 1px solid rgba(56, 189, 248, 0.3); text-align: center; }
        .modal input { width: 100%; padding: 16px; border-radius: 12px; border: 2px solid #1e293b; background: #070b14; color: white; font-weight: 600; font-size: 16px; outline: none; margin-bottom: 12px; box-sizing: border-box; }
        .btn-submit { width: 100%; background: var(--light-blue); color: var(--dark-blue); padding: 16px; border-radius: 12px; font-weight: 900; text-transform: uppercase; cursor: pointer; border: none; margin-top: 20px; }

        /* PROFILE MODAL STYLES */
        .profile-card { text-align: left; }
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; border-bottom: 1px solid var(--mid-blue); padding-bottom: 20px; }
        .profile-avatar { width: 60px; height: 60px; background: var(--light-blue); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--dark-blue); font-weight: 900; }
        .profile-username { font-size: 1.8rem; font-weight: 900; margin: 0; text-transform: uppercase; }
        .profile-stat-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .profile-stat-label { color: var(--text-muted); font-weight: 600; font-size: 13px; }
        .profile-stat-value { font-weight: 800; font-size: 14px; }
        .value-green { color: var(--accent-green); }

        /* FRIENDS STYLING */
        .btn-friend { background: #1e293b; color: white; border: 1px solid var(--light-blue); padding: 10px; border-radius: 8px; width: 100%; margin-top: 15px; cursor: pointer; font-weight: 800; transition: 0.3s; }
        .btn-friend:disabled { opacity: 0.5; cursor: not-allowed; }
        .friends-list-container { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .friend-item { background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--mid-blue); display: flex; align-items: center; justify-content: space-between; cursor: pointer; position: relative; }
        .friend-item:hover { border-color: var(--light-blue); }
        .unread-dot { width: 10px; height: 10px; background: var(--light-blue); border-radius: 50%; position: absolute; left: -5px; top: 50%; transform: translateY(-50%); box-shadow: 0 0 10px var(--light-blue); }
        
        .request-actions { display: flex; gap: 8px; }
        .btn-accept { background: var(--accent-green); border: none; color: black; padding: 6px 12px; border-radius: 4px; font-weight: 900; cursor: pointer; }
        .btn-decline { background: #ef4444; border: none; color: white; padding: 6px 12px; border-radius: 4px; font-weight: 900; cursor: pointer; }

        /* CHAT SYSTEM STYLES */
        .chat-modal { width: 500px; max-width: 95vw; display: flex; flex-direction: column; height: 600px; padding: 0; overflow: hidden; text-align: left; }
        .chat-header { background: #070b14; padding: 20px; border-bottom: 1px solid var(--mid-blue); display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; background: #0b1120; }
        .message-wrapper { display: flex; flex-direction: column; width: 100%; }
        .message { max-width: 80%; padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.4; position: relative; }
        .msg-sent { align-self: flex-end; background: var(--light-blue); color: var(--dark-blue); font-weight: 600; border-bottom-right-radius: 2px; }
        .msg-received { align-self: flex-start; background: var(--mid-blue); color: white; border-bottom-left-radius: 2px; }
        .msg-meta { font-size: 9px; color: var(--text-muted); margin-top: 4px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .meta-sent { text-align: right; }
        .meta-received { text-align: left; }
        
        /* TYPING INDICATOR */
        .typing-bubble { display: none; align-self: flex-start; background: var(--mid-blue); padding: 12px 16px; border-radius: 12px; border-bottom-left-radius: 2px; margin-bottom: 10px; }
        .dot { height: 6px; width: 6px; background: #94a3b8; border-radius: 50%; display: inline-block; margin-right: 3px; animation: bounce 1.4s infinite ease-in-out; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; margin-right: 0; }
        @keyframes bounce { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-6px); } }

        .chat-input-area { background: #070b14; padding: 15px; border-top: 1px solid var(--mid-blue); display: flex; gap: 10px; }
        .chat-input-area input { flex: 1; background: #111827; border: 1px solid var(--mid-blue); border-radius: 8px; color: white; padding: 12px; outline: none; }
        .btn-chat-send { background: var(--light-blue); border: none; padding: 0 20px; border-radius: 8px; font-weight: 900; cursor: pointer; }

        .footer { text-align: center; padding: 40px 0; color: #475569; font-weight: 700; font-size: 10px; letter-spacing: 2px; }
    </style>
</head>
<body>

<nav>
    <div class="logo" onclick="location.href='index.html'">UNIVERSAL<span>-BET</span></div>
    <div class="nav-right">
        <div class="header-reward-box" id="headerReward" onclick="claimBonus()">
            <span class="reward-icon">üéÅ</span>
            <span id="headerTimer" class="reward-timer-text">Loading...</span>
        </div>
        <div class="balance-box" id="balanceDisplay"><span id="navBal">$0.00</span></div>
    </div>
</nav>

<div class="main-content">
    <aside class="sidebar">
        <a href="index.html" class="side-link active-link"><span>üè†</span> Home</a>
        <div class="sidebar-label">Games</div>
        <a href="blackjack.html" class="side-link"><span>üÉè</span> Blackjack</a>
        <a href="dice.html" class="side-link"><span>üé≤</span> Dice</a>
        <a href="mines.html" class="side-link"><span>üí£</span> Mines</a>
        <a href="rps.html" class="side-link"><span>‚úä</span> Rock Paper Scissors</a>
        <a href="slots.html" class="side-link"><span>üé∞</span> Slots</a>
        <a href="tower.html" class="side-link"><span>üóº</span> Tower</a>
    </aside>

    <main class="dashboard">
        <div class="status-header" id="headerContent">
            <h1>Welcome to <span class="highlight">Universal-Bet</span></h1>
            <p>Ready to get on that leaderboard???</p>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('news')">Latest News</button>
            <button class="tab-btn" onclick="switchTab('leaderboard')">Leaderboard</button>
            <button class="tab-btn" onclick="switchTab('chatsTab')">
                Chats
                <span id="chatBadge" class="notify-badge"></span>
            </button>
            <button class="tab-btn" onclick="switchTab('friendsTab')">
                Friends
                <span id="friendBadge" class="notify-badge"></span>
            </button>
            <button class="tab-btn" onclick="switchTab('about')">About</button>
        </div>

<div id="news" class="tab-content active">
            <div class="news-container">
                <div class="news-main">
                    <div class="news-card">
                        <span class="news-tag tag-update">FIX</span>
                        <h2 class="news-title">FIXED MONEY GLITCH</h2>
                        <p class="news-excerpt">Fixed money glitch with mines!!</p>
                    </div>

                    <div class="news-card">
                        <span class="news-tag tag-update">NEW FEATURE</span>
                        <h2 class="news-title">CHATS ADDED!</h2>
                        <p class="news-excerpt">We have made it so you can chat with friends now!</p>
                    </div>
                </div>

                <div class="live-feed">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="font-size:12px; text-transform:uppercase; letter-spacing:1px; margin:0;">Live Feed</h3>
                        <span class="news-tag tag-live" style="margin:0;">Live</span>
                    </div>
                    <div id="liveJackpotFeed" class="feed-scroll">
                        <div class="feed-item" style="color: var(--text-muted)">Connecting...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="leaderboard" class="tab-content">
            <table class="leaderboard-table">
                <thead>
                    <tr><th>Rank</th><th>Player</th><th style="text-align: right;">Total Balance</th></tr>
                </thead>
                <tbody id="leaderboardBody"></tbody>
            </table>
        </div>

        <div id="chatsTab" class="tab-content">
            <h3 style="font-size:12px; color:var(--text-muted); text-transform:uppercase;">Recent Conversations</h3>
            <div id="conversationsList" class="friends-list-container">
                <p style="color:var(--text-muted)">No active chats found.</p>
            </div>
        </div>

        <div id="friendsTab" class="tab-content">
            <h3 id="requestTitle" style="display:none; font-size:12px; color:var(--light-blue); text-transform:uppercase;">Pending Requests</h3>
            <div id="requestsList" class="friends-list-container"></div>
            
            <h3 style="margin-top:30px; font-size:12px; color:var(--text-muted); text-transform:uppercase;">My Friends</h3>
            <div id="friendsList" class="friends-list-container">
                <p style="color:var(--text-muted)">You haven't added any friends yet.</p>
            </div>
        </div>

        <div id="about" class="tab-content">
            <div class="about-box">
                <h3>üèÜ Universal-Bet</h3>
                <p>A secure, real-time fake gambling platform with a competitive leaderboard.</p>
                <p>Developed by <b>FUSIONZZZ</b>.</p>
            </div>
        </div>

        <div class="footer">WEBSITE MADE BY FUSIONZZZ</div>
    </main>
</div>

<div class="modal-overlay" id="modalOverlay" style="display:none">
    <div class="modal">
        <h2>Sign Up/Log In</h2>
        <input type="text" id="usernameInput" placeholder="Username">
        <input type="password" id="passwordInput" placeholder="Password">
        <button class="btn-submit" onclick="handleAuth()">Confirm Identity</button>
    </div>
</div>

<div class="modal-overlay" id="profileOverlay" style="display:none" onclick="if(event.target == this) this.style.display='none'">
    <div class="modal profile-card">
        <div class="profile-header">
            <div class="profile-avatar" id="pAvatar">?</div>
            <div>
                <h2 class="profile-username" id="pUsername">USER</h2>
                <span style="font-size:10px; color:var(--text-muted); font-weight:800;">PLAYER PROFILE</span>
            </div>
        </div>
        <div class="profile-stat-row">
            <span class="profile-stat-label">Leaderboard Rank</span>
            <span class="profile-stat-value" id="pRank">#--</span>
        </div>
        <div class="profile-stat-row">
            <span class="profile-stat-label">Total Balance</span>
            <span class="profile-stat-value value-green" id="pBalance">$0.00</span>
        </div>
        <button id="pFriendBtn" class="btn-friend" onclick="sendFriendRequest()">+ Send Request</button>
        <button class="btn-submit" onclick="document.getElementById('profileOverlay').style.display='none'">Close Profile</button>
    </div>
</div>

<div class="modal-overlay" id="chatOverlay" style="display:none" onclick="if(event.target == this) closeChat()">
    <div class="modal chat-modal">
        <div class="chat-header">
            <h2 id="chatWithTitle" style="margin:0; font-size:18px;">Chatting with...</h2>
            <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div id="typingIndicator" class="typing-bubble" style="margin-left: 20px;">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
            <button class="btn-chat-send" onclick="sendChatMessage()">SEND</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDAr9GqIDPWGw0ojEYPL1eigfMeqTGsfT0",
        authDomain: "universalbet-427ce.firebaseapp.com",
        databaseURL: "https://universalbet-427ce-default-rtdb.firebaseio.com",
        projectId: "universalbet-427ce",
        storageBucket: "universalbet-427ce.firebasestorage.app",
        messagingSenderId: "804592033030",
        appId: "1:804592033030:web:352d7f4e8a75fb3f215287"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentLocalUser = null;
    let lastKnownBalances = {}; 
    let activeChatFriend = null;
    let chatListener = null;
    let typingTimeout = null;
    let globalMsgListener = null;

    const badWords = ["fuck", "shit", "bitch", "asshole", "dick", "pussy", "nigger", "cunt", "faggot", "bastard", "slut", "whore"];
    function filterText(text) {
        let filtered = text;
        badWords.forEach(word => {
            const regex = new RegExp(word, "gi");
            filtered = filtered.replace(regex, "****");
        });
        return filtered;
    }

    function checkAuth() {
        const localUser = JSON.parse(localStorage.getItem('currentUser'));
        if (localUser?.name) {
            db.ref('users/' + localUser.name.toLowerCase()).once('value', (snap) => {
                if(snap.exists()){
                    currentLocalUser = snap.val();
                    startLiveSync();
                    initPersistentFeed(); 
                    startPresence(); 
                    listenForGlobalMessages();
                } else {
                    localStorage.removeItem('currentUser');
                    document.getElementById('modalOverlay').style.display = 'flex';
                }
            });
        } else {
            document.getElementById('modalOverlay').style.display = 'flex';
        }
    }

    function startPresence() {
        if(!currentLocalUser) return;
        const userRef = db.ref('users/' + currentLocalUser.name.toLowerCase());
        userRef.update({ lastSeen: Date.now() });
        setInterval(() => { userRef.update({ lastSeen: Date.now() }); }, 30000);
    }

    function handleAuth() {
        const nameInput = document.getElementById('usernameInput').value.trim();
        const passInput = document.getElementById('passwordInput').value.trim();
        if (nameInput.length < 3 || passInput.length < 4) return alert("Invalid inputs");
        const name = nameInput.toLowerCase().replace(/[^a-z0-9]/g, "");
        db.ref('users/' + name).once('value').then((snap) => {
            if (snap.exists()) {
                if (snap.val().password === passInput) {
                    localStorage.setItem('currentUser', JSON.stringify(snap.val()));
                    location.reload();
                } else { alert("Incorrect password!"); }
            } else {
                const newUser = { 
                    name, password: passInput, balance: 100.00, lastBonus: 0,
                    createdAt: Date.now(), lastSeen: Date.now(),
                    friends: {}, requests: {}
                };
                db.ref('users/' + name).set(newUser);
                localStorage.setItem('currentUser', JSON.stringify(newUser));
                location.reload();
            }
        });
    }

    function startLiveSync() {
        db.ref('users/' + currentLocalUser.name.toLowerCase()).on('value', (snap) => {
            if (snap.exists()) {
                currentLocalUser = snap.val();
                updateUI(currentLocalUser);
                checkRequestBadge();
                if(document.getElementById('friendsTab').classList.contains('active')) fetchFriends();
                if(document.getElementById('chatsTab').classList.contains('active')) fetchChatsList();
            }
        });
    }

    function checkRequestBadge() {
        const fBadge = document.getElementById('friendBadge');
        if (currentLocalUser.requests && Object.keys(currentLocalUser.requests).length > 0) {
            fBadge.style.display = 'block';
        } else {
            fBadge.style.display = 'none';
        }
    }

    // LISTENS FOR ANY UNREAD MESSAGES GLOBALLY
    function listenForGlobalMessages() {
        if(globalMsgListener) globalMsgListener.off();
        globalMsgListener = db.ref('chats');
        globalMsgListener.on('value', (snap) => {
            let hasUnread = false;
            const myName = currentLocalUser.name.toLowerCase();
            snap.forEach(chatSnap => {
                if(chatSnap.key.includes(myName)) {
                    chatSnap.forEach(msgSnap => {
                        const msg = msgSnap.val();
                        if(msg.sender !== myName && !msg.read) {
                            hasUnread = true;
                        }
                    });
                }
            });
            document.getElementById('chatBadge').style.display = hasUnread ? 'block' : 'none';
            if(document.getElementById('chatsTab').classList.contains('active')) fetchChatsList();
        });
    }

    function updateUI(user) {
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('balanceDisplay').style.visibility = 'visible';
        document.getElementById('headerReward').style.display = 'flex';
        document.getElementById('navBal').innerText = `$${user.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('headerContent').innerHTML = `<h1>Welcome back, <span class="highlight">${user.name.toUpperCase()}</span>!</h1><p>Ready to get on that leaderboard???</p>`;
        if (window.rewardInterval) clearInterval(window.rewardInterval);
        window.rewardInterval = setInterval(() => updateTimer(user), 1000);
        updateTimer(user);
    }

    function updateTimer(user) {
        const bonusInterval = 5 * 60 * 1000;
        const diff = bonusInterval - (Date.now() - (user.lastBonus || 0));
        const timerText = document.getElementById('headerTimer');
        const rewardBox = document.getElementById('headerReward');
        if (diff > 0) {
            const m = Math.floor(diff / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            timerText.innerText = `${m}M ${s}S`;
            rewardBox.style.opacity = "0.5"; rewardBox.style.pointerEvents = "none";
        } else {
            timerText.innerText = "Claim $10.00";
            rewardBox.style.opacity = "1"; rewardBox.style.pointerEvents = "auto";
        }
    }

    function claimBonus() {
        db.ref('users/' + currentLocalUser.name.toLowerCase()).transaction(u => {
            if(u){ 
                const bonusInterval = 5 * 60 * 1000;
                if(Date.now() - (u.lastBonus || 0) >= bonusInterval) {
                    u.balance += 10.00; 
                    u.lastBonus = Date.now();
                }
            }
            return u;
        });
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        if(event) event.currentTarget.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(tabId === 'leaderboard') fetchLeaderboard();
        if(tabId === 'friendsTab') fetchFriends();
        if(tabId === 'chatsTab') fetchChatsList();
    }

    function fetchLeaderboard() {
        db.ref('users').on('value', (snap) => {
            let users = [];
            snap.forEach(child => { users.push(child.val()); });
            document.getElementById('leaderboardBody').innerHTML = users.sort((a,b)=>b.balance-a.balance).slice(0,15).map((u,i)=>`
                <tr><td><span class="rank-badge ${i<3?`rank-${i+1}`:''}">#${i+1}</span></td><td class="player-cell" onclick="viewProfile('${u.name}')">${u.name.toUpperCase()}</td><td class="bal-cell">$${u.balance.toFixed(2)}</td></tr>
            `).join('');
        });
    }

    function initPersistentFeed() {
        const feedRef = db.ref('recent_wins');
        db.ref('users').on('value', (snap) => {
            snap.forEach(child => {
                const user = child.val();
                const userId = user.name.toLowerCase();
                const newBal = user.balance;
                const oldBal = lastKnownBalances[userId];
                if (oldBal !== undefined && newBal > oldBal) {
                    feedRef.push({ name: user.name.toUpperCase(), amount: newBal - oldBal, timestamp: Date.now() });
                }
                lastKnownBalances[userId] = newBal;
            });
        });
        feedRef.limitToLast(10).on('value', (snap) => {
            const feedContainer = document.getElementById('liveJackpotFeed');
            feedContainer.innerHTML = "";
            let wins = [];
            snap.forEach(child => { wins.push(child.val()); });
            wins.reverse().forEach(win => {
                const timeStr = new Date(win.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const item = document.createElement('div');
                item.className = 'feed-item';
                item.innerHTML = `<div class="feed-top"><span class="feed-user" onclick="viewProfile('${win.name}')">${win.name}</span><span class="feed-amount">+$${win.amount.toFixed(2)}</span></div><div class="feed-time">${timeStr}</div>`;
                feedContainer.appendChild(item);
            });
        });
    }

    function viewProfile(username) {
        db.ref('users').once('value', (snap) => {
            let allUsers = [];
            snap.forEach(c => { allUsers.push(c.val()); });
            allUsers.sort((a,b) => b.balance - a.balance);
            const userIdx = allUsers.findIndex(u => u.name.toLowerCase() === username.toLowerCase());
            const targetUser = allUsers[userIdx];
            if(!targetUser) return;
            currentViewingUser = targetUser.name.toLowerCase();
            document.getElementById('pUsername').innerText = targetUser.name;
            document.getElementById('pAvatar').innerText = targetUser.name.charAt(0).toUpperCase();
            document.getElementById('pBalance').innerText = `$${targetUser.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('pRank').innerText = `#${userIdx + 1}`;
            const friendBtn = document.getElementById('pFriendBtn');
            if (currentViewingUser === currentLocalUser.name.toLowerCase()) { friendBtn.style.display = 'none'; } else {
                friendBtn.style.display = 'block'; friendBtn.disabled = false;
                const isFriend = currentLocalUser.friends && currentLocalUser.friends[currentViewingUser];
                const hasSentRequest = targetUser.requests && targetUser.requests[currentLocalUser.name.toLowerCase()];
                if (isFriend) { friendBtn.innerText = "Remove Friend"; friendBtn.onclick = removeFriend; }
                else if (hasSentRequest) { friendBtn.innerText = "Request Pending..."; friendBtn.disabled = true; }
                else { friendBtn.innerText = "+ Send Request"; friendBtn.onclick = sendFriendRequest; }
            }
            document.getElementById('profileOverlay').style.display = 'flex';
        });
    }

    function sendFriendRequest() {
        db.ref(`users/${currentViewingUser}/requests/${currentLocalUser.name.toLowerCase()}`).set(true);
        alert("Friend request sent!");
        document.getElementById('profileOverlay').style.display = 'none';
    }

    function removeFriend() {
        if(!confirm(`Remove ${currentViewingUser.toUpperCase()} from friends?`)) return;
        db.ref(`users/${currentLocalUser.name.toLowerCase()}/friends/${currentViewingUser}`).remove();
        db.ref(`users/${currentViewingUser}/friends/${currentLocalUser.name.toLowerCase()}`).remove();
        document.getElementById('profileOverlay').style.display = 'none';
    }

    function acceptRequest(requester) {
        db.ref(`users/${currentLocalUser.name.toLowerCase()}/friends/${requester}`).set(true);
        db.ref(`users/${requester}/friends/${currentLocalUser.name.toLowerCase()}`).set(true);
        db.ref(`users/${currentLocalUser.name.toLowerCase()}/requests/${requester}`).remove();
    }

    function declineRequest(requester) {
        db.ref(`users/${currentLocalUser.name.toLowerCase()}/requests/${requester}`).remove();
    }

    function fetchFriends() {
        const friendsList = document.getElementById('friendsList');
        const reqList = document.getElementById('requestsList');
        const reqTitle = document.getElementById('requestTitle');
        db.ref('users').once('value', (snap) => {
            reqList.innerHTML = "";
            const requests = currentLocalUser.requests ? Object.keys(currentLocalUser.requests) : [];
            if (requests.length > 0) {
                reqTitle.style.display = 'block';
                requests.forEach(reqName => {
                    const item = document.createElement('div');
                    item.className = 'friend-item';
                    item.innerHTML = `<span style="font-weight:800;">${reqName.toUpperCase()}</span><div class="request-actions"><button class="btn-accept" onclick="acceptRequest('${reqName}')">Accept</button><button class="btn-decline" onclick="declineRequest('${reqName}')">‚úï</button></div>`;
                    reqList.appendChild(item);
                });
            } else { reqTitle.style.display = 'none'; }
            friendsList.innerHTML = "";
            const friends = currentLocalUser.friends ? Object.keys(currentLocalUser.friends) : [];
            if (friends.length > 0) {
                friends.forEach(fName => {
                    const userData = snap.child(fName).val();
                    if (userData) {
                        const item = document.createElement('div');
                        item.className = 'friend-item';
                        item.onclick = () => openChat(userData.name);
                        item.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><div class="profile-avatar" style="width:30px; height:30px; font-size:12px;">${userData.name.charAt(0).toUpperCase()}</div><span style="font-weight:800;">${userData.name.toUpperCase()}</span></div><span style="font-size:10px; color:var(--light-blue); font-weight:800;">MESSAGE ></span>`;
                        friendsList.appendChild(item);
                    }
                });
            } else { friendsList.innerHTML = '<p style="color:var(--text-muted)">No friends yet.</p>'; }
        });
    }

    // FETCHES ALL ACTIVE CONVERSATIONS FOR THE CHATS TAB
    function fetchChatsList() {
        const conversationsList = document.getElementById('conversationsList');
        const myName = currentLocalUser.name.toLowerCase();
        
        db.ref('chats').once('value', (snap) => {
            conversationsList.innerHTML = "";
            let chatFound = false;
            snap.forEach(chatSnap => {
                if(chatSnap.key.includes(myName)) {
                    chatFound = true;
                    const participants = chatSnap.key.split('_');
                    const friendName = participants.find(p => p !== myName);
                    
                    let unreadCount = 0;
                    let lastMsg = "No messages yet";
                    chatSnap.forEach(msgSnap => {
                        const m = msgSnap.val();
                        lastMsg = m.text;
                        if(m.sender !== myName && !m.read) unreadCount++;
                    });

                    const item = document.createElement('div');
                    item.className = 'friend-item';
                    item.onclick = () => openChat(friendName);
                    item.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px;">
                            ${unreadCount > 0 ? '<div class="unread-dot"></div>' : ''}
                            <div class="profile-avatar" style="width:35px; height:35px; font-size:14px;">${friendName.charAt(0).toUpperCase()}</div>
                            <div>
                                <div style="font-weight:800;">${friendName.toUpperCase()}</div>
                                <div style="font-size:11px; color:var(--text-muted); width:150px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${lastMsg}</div>
                            </div>
                        </div>
                        <span style="font-size:10px; color:${unreadCount > 0 ? 'var(--light-blue)' : 'var(--text-muted)'}; font-weight:800;">${unreadCount > 0 ? unreadCount + ' NEW' : 'VIEW'}</span>
                    `;
                    conversationsList.appendChild(item);
                }
            });
            if(!chatFound) conversationsList.innerHTML = '<p style="color:var(--text-muted)">No active chats. Start one from the Friends tab!</p>';
        });
    }

    /* CHAT CORE */
    function openChat(friendName) {
        activeChatFriend = friendName.toLowerCase();
        document.getElementById('chatWithTitle').innerText = `Chat with ${friendName.toUpperCase()}`;
        document.getElementById('chatOverlay').style.display = 'flex';
        const myName = currentLocalUser.name.toLowerCase();
        const chatId = [myName, activeChatFriend].sort().join('_');
        if(chatListener) chatListener.off();
        db.ref(`typing/${chatId}/${activeChatFriend}`).on('value', (snap) => {
            document.getElementById('typingIndicator').style.display = snap.val() ? 'block' : 'none';
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
        chatListener = db.ref(`chats/${chatId}`).limitToLast(50);
        chatListener.on('value', (snap) => {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = "";
            snap.forEach(child => {
                const msg = child.val();
                const isSent = msg.sender === myName;
                if(!isSent && !msg.read) { db.ref(`chats/${chatId}/${child.key}`).update({read: true}); }
                const dateObj = new Date(msg.timestamp);
                const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const dateStr = dateObj.toLocaleDateString([], {month: 'short', day: 'numeric'});
                const receipt = isSent ? (msg.read ? " ‚Ä¢ Read" : " ‚Ä¢ Sent") : "";
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper';
                wrapper.innerHTML = `<div class="message ${isSent ? 'msg-sent' : 'msg-received'}">${msg.text}</div><div class="msg-meta ${isSent ? 'meta-sent' : 'meta-received'}">${dateStr} ‚Ä¢ ${timeStr}${receipt}</div>`;
                messagesContainer.appendChild(wrapper);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
        document.getElementById('chatInput').oninput = () => {
            db.ref(`typing/${chatId}/${myName}`).set(true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => db.ref(`typing/${chatId}/${myName}`).set(false), 2000);
        };
    }

    function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const rawText = input.value.trim();
        if (!rawText || !activeChatFriend) return;
        const myName = currentLocalUser.name.toLowerCase();
        const chatId = [myName, activeChatFriend].sort().join('_');
        const cleanText = filterText(rawText);
        db.ref(`chats/${chatId}`).push({ sender: myName, text: cleanText, timestamp: Date.now(), read: false });
        db.ref(`typing/${chatId}/${myName}`).set(false);
        input.value = "";
    }

    function closeChat() {
        if(activeChatFriend) {
            const myName = currentLocalUser.name.toLowerCase();
            const chatId = [myName, activeChatFriend].sort().join('_');
            db.ref(`typing/${chatId}/${myName}`).set(false);
            db.ref(`typing/${chatId}/${activeChatFriend}`).off();
        }
        if(chatListener) chatListener.off();
        document.getElementById('chatOverlay').style.display = 'none';
        activeChatFriend = null;
        fetchChatsList(); // Refresh the list to clear dots
    }

    checkAuth();
</script>
</body>
</html>
