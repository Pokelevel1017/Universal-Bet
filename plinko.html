<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal-Bet | Plinko</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { 
            --dark-blue: #0b1120; 
            --mid-blue: #1e293b; 
            --light-blue: #38bdf8; 
            --win-green: #00e701; 
            --loss-red: #ff4949; 
            --peg-color: #64748b;
        }

        body { 
            background-color: var(--dark-blue); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            overflow: hidden; 
        }

        nav { 
            background: #070b14; 
            padding: 0 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 64px; 
            border-bottom: 1px solid var(--mid-blue); 
        }

        #balDisp { color: #00e701; font-weight: 800; background: #1e293b; padding: 8px 15px; border-radius: 6px; }

        .viewport { height: calc(100vh - 64px); display: flex; }

        .sidebar { 
            width: 300px; 
            background: #111827; 
            border-right: 1px solid var(--mid-blue); 
            padding: 24px; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
            box-sizing: border-box;
        }

        .label { 
            font-size: 11px; 
            font-weight: 800; 
            color: #94a3b8; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin-bottom: 8px; 
            display: block; 
        }

        .bet-input-wrapper { 
            background: var(--dark-blue); 
            border: 1px solid var(--mid-blue); 
            border-radius: 8px; 
            padding: 12px; 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center;
        }

        .bet-input-wrapper input, .bet-input-wrapper select { 
            background: var(--dark-blue); 
            border: none; 
            color: white; 
            font-weight: 800; 
            width: 100%; 
            outline: none; 
            font-size: 1rem; 
            appearance: none;
            cursor: pointer;
        }

        select option { background: #111827; }

        .btn-main { 
            background: var(--light-blue); 
            color: var(--dark-blue); 
            width: 100%; 
            padding: 16px; 
            border-radius: 8px; 
            font-weight: 800; 
            border: none; 
            cursor: pointer; 
            transition: 0.2s; 
            text-transform: uppercase; 
            letter-spacing: 1px;
        }

        .btn-main:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-main:active { transform: translateY(0) scale(0.98); }

        .stage { 
            flex: 1; 
            background: #0f172a; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            overflow: hidden;
        }
        
        canvas { 
            background: transparent; 
            max-width: 100%; 
            max-height: 95%; 
        }

        .recent-wins { 
            position: absolute; 
            right: 20px; 
            top: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }

        .win-tag {
            background: var(--mid-blue); 
            padding: 5px 12px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: 900; 
            border-left: 3px solid var(--light-blue);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <nav>
        <div onclick="location.href='index.html'" style="cursor:pointer; font-weight:900;">UNIVERSAL<span>-BET</span></div>
        <div id="balDisp">$0.00</div>
    </nav>

    <div class="viewport">
        <div class="sidebar">
            <span class="label">Bet Amount</span>
            <div class="bet-input-wrapper"><input type="number" id="pBet" value="10.00"></div>

            <span class="label">Risk Level</span>
            <div class="bet-input-wrapper">
                <select id="riskLevel" onchange="initBoard()">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>

            <span class="label">Rows</span>
            <div class="bet-input-wrapper">
                <select id="rowCount" onchange="initBoard()">
                    <option value="8">8 Rows</option>
                    <option value="9">9 Rows</option>
                    <option value="10">10 Rows</option>
                    <option value="11">11 Rows</option>
                    <option value="12">12 Rows</option>
                    <option value="13">13 Rows</option>
                    <option value="14">14 Rows</option>
                    <option value="15">15 Rows</option>
                    <option value="16" selected>16 Rows</option>
                </select>
            </div>

            <button class="btn-main" onclick="dropBall()">Drop Ball</button>
            <div style="margin-top:auto; font-size:10px; color:#475569; text-align:center;">NONCE: <span id="nonceDisp">0</span></div>
        </div>

        <div class="stage">
            <canvas id="plinkoCanvas"></canvas>
            <div class="recent-wins" id="recentWins"></div>
        </div>
    </div>

    <script>
        // --- DATA SYNC SYSTEM ---
        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        let allUsers = JSON.parse(localStorage.getItem('users'));
        if (!currentUser) window.location.href = 'index.html';

        let bal = currentUser.balance;
        let nonce = 0, balls = [], pegs = [], multipliers = [];
        const serverSeed = "7d8f9e0a1b2c3d4e5f6g7h8i9j0k"; 
        const clientSeed = "universal_user_client";

        function updateStorage() {
            currentUser.balance = bal;
            if (allUsers && allUsers[currentUser.name]) {
                allUsers[currentUser.name].balance = bal;
            }
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('users', JSON.stringify(allUsers));
            document.getElementById('balDisp').innerText = `$${bal.toLocaleString(undefined, {minimumFractionDigits:2})}`; 
            document.getElementById('nonceDisp').innerText = nonce;
        }

        // --- GAME ENGINE ---
        const canvas = document.getElementById('plinkoCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800; canvas.height = 750;

        const ballRadius = 6, pegRadius = 3.5, gravity = 0.08;

        const payoutData = {
            low: {
                8: [5.6, 2.1, 1.1, 1, 0.5, 1, 1.1, 2.1, 5.6],
                9: [5.6, 2, 1.6, 1, 0.7, 0.7, 1, 1.6, 2, 5.6],
                10: [8.9, 3, 1.4, 1.1, 1, 0.5, 1, 1.1, 1.4, 3, 8.9],
                11: [8.4, 3, 1.9, 1.3, 1, 0.7, 0.7, 1, 1.3, 1.9, 3, 8.4],
                12: [10, 3, 1.6, 1.4, 1.2, 1.1, 1, 1.1, 1.2, 1.4, 1.6, 3, 10],
                13: [8.1, 4, 3, 2, 1.2, 0.9, 0.7, 0.7, 0.9, 1.2, 2, 3, 4, 8.1],
                14: [7.1, 4, 1.9, 1.4, 1.3, 1.1, 1, 0.5, 1, 1.1, 1.3, 1.4, 1.9, 4, 7.1],
                15: [15, 8, 3, 2, 1.5, 1.1, 1, 0.7, 0.7, 1, 1.1, 1.5, 2, 3, 8, 15],
                16: [16, 9, 2, 1.4, 1.4, 1.2, 1.1, 1, 0.5, 1, 1.1, 1.2, 1.4, 1.4, 2, 9, 16]
            },
            medium: {
                8: [13, 3, 1.3, 0.7, 0.4, 0.7, 1.3, 3, 13],
                10: [22, 5, 2, 1.4, 0.6, 0.4, 0.6, 1.4, 2, 5, 22],
                12: [33, 11, 4, 2, 1.1, 0.6, 0.3, 0.6, 1.1, 2, 4, 11, 33],
                14: [58, 15, 7, 4, 1.9, 1, 0.5, 0.2, 0.5, 1, 1.9, 4, 7, 15, 58],
                16: [110, 41, 10, 5, 3, 1.5, 1, 0.5, 0.3, 0.5, 1, 1.5, 3, 5, 10, 41, 110]
            },
            high: {
                8: [29, 4, 1.5, 0.3, 0.2, 0.3, 1.5, 4, 29],
                10: [76, 10, 3, 1.4, 0.3, 0.2, 0.3, 1.4, 3, 10, 76],
                12: [170, 24, 8.1, 2, 0.7, 0.2, 0.2, 0.2, 0.7, 2, 8.1, 24, 170],
                14: [420, 56, 18, 6, 3, 1, 0.2, 0.2, 0.2, 1, 3, 6, 18, 56, 420],
                16: [1000, 130, 26, 9, 4, 2, 0.2, 0.2, 0.2, 0.2, 0.2, 2, 4, 9, 26, 130, 1000]
            }
        };

        function initBoard() {
            pegs = [];
            const rows = parseInt(document.getElementById('rowCount').value);
            const spacingX = 38, spacingY = 32;
            for (let i = 0; i < rows; i++) {
                const rowWidth = i * spacingX;
                const startX = canvas.width / 2 - rowWidth / 2;
                for (let j = 0; j <= i; j++) {
                    pegs.push({ x: startX + j * spacingX, y: 60 + i * spacingY });
                }
            }
            multipliers = payoutData[document.getElementById('riskLevel').value][rows] || payoutData['medium'][16];
            updateStorage();
        }

        class Ball {
            constructor(bet, risk, row_count, path) {
                this.x = canvas.width / 2;
                this.y = 30; this.vx = 0; this.vy = 0;
                this.bet = bet; this.risk = risk; this.row_count = row_count;
                this.path = path; this.step = 0; this.active = true;
            }
            update() {
                this.vy += gravity;
                this.x += this.vx; this.y += this.vy;
                this.vx *= 0.98;
                pegs.forEach(peg => {
                    const dx = this.x - peg.x, dy = this.y - peg.y, dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < ballRadius + pegRadius && this.step < this.row_count) {
                        const direction = this.path[this.step] === 1 ? 1 : -1;
                        this.vx = direction * 1.6; this.vy = 1.2; this.step++;
                    }
                });
                if (this.y > 60 + (this.row_count * 32) + 20) {
                    this.active = false; this.onLand();
                }
            }
            onLand() {
                const plinko_ticket = this.path.reduce((a, b) => a + b, 0);
                const mult = multipliers[plinko_ticket] || 0;
                bal += this.bet * mult;
                showWin(mult);
                updateStorage();
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, ballRadius, 0, Math.PI*2);
                ctx.fillStyle = this.risk === 'high' ? '#ff4949' : (this.risk === 'medium' ? '#fb923c' : '#38bdf8');
                ctx.shadowBlur = 10; ctx.shadowColor = ctx.fillStyle;
                ctx.fill(); ctx.closePath(); ctx.shadowBlur = 0;
            }
        }

        function showWin(mult) {
            const tag = document.createElement('div');
            tag.className = 'win-tag'; tag.innerText = mult + 'x';
            tag.style.color = mult >= 1 ? 'var(--win-green)' : 'var(--loss-red)';
            document.getElementById('recentWins').prepend(tag);
            if (recentWins.children.length > 8) recentWins.lastChild.remove();
        }

        function dropBall() {
            const bet = parseFloat(document.getElementById('pBet').value);
            const row_count = parseInt(document.getElementById('rowCount').value);
            if (bet > bal || bet <= 0) return alert("Insufficient funds!");
            
            bal -= bet; 
            nonce++; 
            updateStorage();

            const combined_seed = CryptoJS.SHA256(serverSeed + ":" + clientSeed + ":" + nonce).toString();
            let path = [];
            for (let x = 0; x < 64; x = x + 4) {
                path.push(parseInt(combined_seed.substring(x, x + 1), 16) > 7 ? 1 : 0);
            }
            balls.push(new Ball(bet, document.getElementById('riskLevel').value, row_count, path.slice(0, row_count)));
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#475569';
            pegs.forEach(p => {
                ctx.beginPath(); ctx.arc(p.x, p.y, pegRadius, 0, Math.PI*2);
                ctx.fill(); ctx.closePath();
            });

            const rows = parseInt(document.getElementById('rowCount').value);
            const spacingX = 38, spacingY = 32;
            const totalWidth = multipliers.length * spacingX;
            const startX = (canvas.width - totalWidth) / 2;
            const yPos = 60 + (rows * spacingY) + 15;

            multipliers.forEach((m, i) => {
                const x = startX + (i * spacingX);
                const gutter = 4;
                ctx.fillStyle = m >= 5 ? 'rgba(0, 231, 1, 0.2)' : (m >= 1 ? 'rgba(56, 189, 248, 0.1)' : 'rgba(255, 73, 73, 0.1)');
                ctx.beginPath();
                if(ctx.roundRect) ctx.roundRect(x + (gutter/2), yPos, spacingX - gutter, 26, 4);
                else ctx.rect(x + (gutter/2), yPos, spacingX - gutter, 26);
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.font = 'bold 9px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(m >= 1000 ? (m/1000)+'k' : m+'x', x + (spacingX / 2), yPos + 17);
            });

            balls = balls.filter(b => b.active);
            balls.forEach(b => { b.update(); b.draw(); });
            requestAnimationFrame(animate);
        }

        initBoard();
        animate();
    </script>
</body>
</html>
